#include "cubement.h"

ihandle_t gconfont;
static font_s gfonts[MAX_FONTS];
static const vec4_t gfontmap[FONT_LETTERS] =
{
	{0, 0, 0.0625, 0.0625}, {0.0625, 0, 0.125, 0.0625}, {0.125, 0, 0.1875, 0.0625}, {0.1875, 0, 0.25, 0.0625}, {0.25, 0, 0.3125, 0.0625}, {0.3125, 0, 0.375, 0.0625}, {0.375, 0, 0.4375, 0.0625}, {0.4375, 0, 0.5, 0.0625}, {0.5, 0, 0.5625, 0.0625}, {0.5625, 0, 0.625, 0.0625}, {0.625, 0, 0.6875, 0.0625}, {0.6875, 0, 0.75, 0.0625}, {0.75, 0, 0.8125, 0.0625}, {0.8125, 0, 0.875, 0.0625}, {0.875, 0, 0.9375, 0.0625}, {0.9375, 0, 1, 0.0625},
	{0, 0.0625, 0.0625, 0.125}, {0.0625, 0.0625, 0.125, 0.125}, {0.125, 0.0625, 0.1875, 0.125}, {0.1875, 0.0625, 0.25, 0.125}, {0.25, 0.0625, 0.3125, 0.125}, {0.3125, 0.0625, 0.375, 0.125}, {0.375, 0.0625, 0.4375, 0.125}, {0.4375, 0.0625, 0.5, 0.125}, {0.5, 0.0625, 0.5625, 0.125}, {0.5625, 0.0625, 0.625, 0.125}, {0.625, 0.0625, 0.6875, 0.125}, {0.6875, 0.0625, 0.75, 0.125}, {0.75, 0.0625, 0.8125, 0.125}, {0.8125, 0.0625, 0.875, 0.125}, {0.875, 0.0625, 0.9375, 0.125}, {0.9375, 0.0625, 1, 0.125},
	{0, 0.125, 0.0625, 0.1875}, {0.0625, 0.125, 0.125, 0.1875}, {0.125, 0.125, 0.1875, 0.1875}, {0.1875, 0.125, 0.25, 0.1875}, {0.25, 0.125, 0.3125, 0.1875}, {0.3125, 0.125, 0.375, 0.1875}, {0.375, 0.125, 0.4375, 0.1875}, {0.4375, 0.125, 0.5, 0.1875}, {0.5, 0.125, 0.5625, 0.1875}, {0.5625, 0.125, 0.625, 0.1875}, {0.625, 0.125, 0.6875, 0.1875}, {0.6875, 0.125, 0.75, 0.1875}, {0.75, 0.125, 0.8125, 0.1875}, {0.8125, 0.125, 0.875, 0.1875}, {0.875, 0.125, 0.9375, 0.1875}, {0.9375, 0.125, 1, 0.1875},
	{0, 0.1875, 0.0625, 0.25}, {0.0625, 0.1875, 0.125, 0.25}, {0.125, 0.1875, 0.1875, 0.25}, {0.1875, 0.1875, 0.25, 0.25}, {0.25, 0.1875, 0.3125, 0.25}, {0.3125, 0.1875, 0.375, 0.25}, {0.375, 0.1875, 0.4375, 0.25}, {0.4375, 0.1875, 0.5, 0.25}, {0.5, 0.1875, 0.5625, 0.25}, {0.5625, 0.1875, 0.625, 0.25}, {0.625, 0.1875, 0.6875, 0.25}, {0.6875, 0.1875, 0.75, 0.25}, {0.75, 0.1875, 0.8125, 0.25}, {0.8125, 0.1875, 0.875, 0.25}, {0.875, 0.1875, 0.9375, 0.25}, {0.9375, 0.1875, 1, 0.25},
	{0, 0.25, 0.0625, 0.3125}, {0.0625, 0.25, 0.125, 0.3125}, {0.125, 0.25, 0.1875, 0.3125}, {0.1875, 0.25, 0.25, 0.3125}, {0.25, 0.25, 0.3125, 0.3125}, {0.3125, 0.25, 0.375, 0.3125}, {0.375, 0.25, 0.4375, 0.3125}, {0.4375, 0.25, 0.5, 0.3125}, {0.5, 0.25, 0.5625, 0.3125}, {0.5625, 0.25, 0.625, 0.3125}, {0.625, 0.25, 0.6875, 0.3125}, {0.6875, 0.25, 0.75, 0.3125}, {0.75, 0.25, 0.8125, 0.3125}, {0.8125, 0.25, 0.875, 0.3125}, {0.875, 0.25, 0.9375, 0.3125}, {0.9375, 0.25, 1, 0.3125},
	{0, 0.3125, 0.0625, 0.375}, {0.0625, 0.3125, 0.125, 0.375}, {0.125, 0.3125, 0.1875, 0.375}, {0.1875, 0.3125, 0.25, 0.375}, {0.25, 0.3125, 0.3125, 0.375}, {0.3125, 0.3125, 0.375, 0.375}, {0.375, 0.3125, 0.4375, 0.375}, {0.4375, 0.3125, 0.5, 0.375}, {0.5, 0.3125, 0.5625, 0.375}, {0.5625, 0.3125, 0.625, 0.375}, {0.625, 0.3125, 0.6875, 0.375}, {0.6875, 0.3125, 0.75, 0.375}, {0.75, 0.3125, 0.8125, 0.375}, {0.8125, 0.3125, 0.875, 0.375}, {0.875, 0.3125, 0.9375, 0.375}, {0.9375, 0.3125, 1, 0.375},
	{0, 0.375, 0.0625, 0.4375}, {0.0625, 0.375, 0.125, 0.4375}, {0.125, 0.375, 0.1875, 0.4375}, {0.1875, 0.375, 0.25, 0.4375}, {0.25, 0.375, 0.3125, 0.4375}, {0.3125, 0.375, 0.375, 0.4375}, {0.375, 0.375, 0.4375, 0.4375}, {0.4375, 0.375, 0.5, 0.4375}, {0.5, 0.375, 0.5625, 0.4375}, {0.5625, 0.375, 0.625, 0.4375}, {0.625, 0.375, 0.6875, 0.4375}, {0.6875, 0.375, 0.75, 0.4375}, {0.75, 0.375, 0.8125, 0.4375}, {0.8125, 0.375, 0.875, 0.4375}, {0.875, 0.375, 0.9375, 0.4375}, {0.9375, 0.375, 1, 0.4375},
	{0, 0.4375, 0.0625, 0.5}, {0.0625, 0.4375, 0.125, 0.5}, {0.125, 0.4375, 0.1875, 0.5}, {0.1875, 0.4375, 0.25, 0.5}, {0.25, 0.4375, 0.3125, 0.5}, {0.3125, 0.4375, 0.375, 0.5}, {0.375, 0.4375, 0.4375, 0.5}, {0.4375, 0.4375, 0.5, 0.5}, {0.5, 0.4375, 0.5625, 0.5}, {0.5625, 0.4375, 0.625, 0.5}, {0.625, 0.4375, 0.6875, 0.5}, {0.6875, 0.4375, 0.75, 0.5}, {0.75, 0.4375, 0.8125, 0.5}, {0.8125, 0.4375, 0.875, 0.5}, {0.875, 0.4375, 0.9375, 0.5}, {0.9375, 0.4375, 1, 0.5},
	{0, 0.5, 0.0625, 0.5625}, {0.0625, 0.5, 0.125, 0.5625}, {0.125, 0.5, 0.1875, 0.5625}, {0.1875, 0.5, 0.25, 0.5625}, {0.25, 0.5, 0.3125, 0.5625}, {0.3125, 0.5, 0.375, 0.5625}, {0.375, 0.5, 0.4375, 0.5625}, {0.4375, 0.5, 0.5, 0.5625}, {0.5, 0.5, 0.5625, 0.5625}, {0.5625, 0.5, 0.625, 0.5625}, {0.625, 0.5, 0.6875, 0.5625}, {0.6875, 0.5, 0.75, 0.5625}, {0.75, 0.5, 0.8125, 0.5625}, {0.8125, 0.5, 0.875, 0.5625}, {0.875, 0.5, 0.9375, 0.5625}, {0.9375, 0.5, 1, 0.5625},
	{0, 0.5625, 0.0625, 0.625}, {0.0625, 0.5625, 0.125, 0.625}, {0.125, 0.5625, 0.1875, 0.625}, {0.1875, 0.5625, 0.25, 0.625}, {0.25, 0.5625, 0.3125, 0.625}, {0.3125, 0.5625, 0.375, 0.625}, {0.375, 0.5625, 0.4375, 0.625}, {0.4375, 0.5625, 0.5, 0.625}, {0.5, 0.5625, 0.5625, 0.625}, {0.5625, 0.5625, 0.625, 0.625}, {0.625, 0.5625, 0.6875, 0.625}, {0.6875, 0.5625, 0.75, 0.625}, {0.75, 0.5625, 0.8125, 0.625}, {0.8125, 0.5625, 0.875, 0.625}, {0.875, 0.5625, 0.9375, 0.625}, {0.9375, 0.5625, 1, 0.625},
	{0, 0.625, 0.0625, 0.6875}, {0.0625, 0.625, 0.125, 0.6875}, {0.125, 0.625, 0.1875, 0.6875}, {0.1875, 0.625, 0.25, 0.6875}, {0.25, 0.625, 0.3125, 0.6875}, {0.3125, 0.625, 0.375, 0.6875}, {0.375, 0.625, 0.4375, 0.6875}, {0.4375, 0.625, 0.5, 0.6875}, {0.5, 0.625, 0.5625, 0.6875}, {0.5625, 0.625, 0.625, 0.6875}, {0.625, 0.625, 0.6875, 0.6875}, {0.6875, 0.625, 0.75, 0.6875}, {0.75, 0.625, 0.8125, 0.6875}, {0.8125, 0.625, 0.875, 0.6875}, {0.875, 0.625, 0.9375, 0.6875}, {0.9375, 0.625, 1, 0.6875},
	{0, 0.6875, 0.0625, 0.75}, {0.0625, 0.6875, 0.125, 0.75}, {0.125, 0.6875, 0.1875, 0.75}, {0.1875, 0.6875, 0.25, 0.75}, {0.25, 0.6875, 0.3125, 0.75}, {0.3125, 0.6875, 0.375, 0.75}, {0.375, 0.6875, 0.4375, 0.75}, {0.4375, 0.6875, 0.5, 0.75}, {0.5, 0.6875, 0.5625, 0.75}, {0.5625, 0.6875, 0.625, 0.75}, {0.625, 0.6875, 0.6875, 0.75}, {0.6875, 0.6875, 0.75, 0.75}, {0.75, 0.6875, 0.8125, 0.75}, {0.8125, 0.6875, 0.875, 0.75}, {0.875, 0.6875, 0.9375, 0.75}, {0.9375, 0.6875, 1, 0.75},
	{0, 0.75, 0.0625, 0.8125}, {0.0625, 0.75, 0.125, 0.8125}, {0.125, 0.75, 0.1875, 0.8125}, {0.1875, 0.75, 0.25, 0.8125}, {0.25, 0.75, 0.3125, 0.8125}, {0.3125, 0.75, 0.375, 0.8125}, {0.375, 0.75, 0.4375, 0.8125}, {0.4375, 0.75, 0.5, 0.8125}, {0.5, 0.75, 0.5625, 0.8125}, {0.5625, 0.75, 0.625, 0.8125}, {0.625, 0.75, 0.6875, 0.8125}, {0.6875, 0.75, 0.75, 0.8125}, {0.75, 0.75, 0.8125, 0.8125}, {0.8125, 0.75, 0.875, 0.8125}, {0.875, 0.75, 0.9375, 0.8125}, {0.9375, 0.75, 1, 0.8125},
	{0, 0.8125, 0.0625, 0.875}, {0.0625, 0.8125, 0.125, 0.875}, {0.125, 0.8125, 0.1875, 0.875}, {0.1875, 0.8125, 0.25, 0.875}, {0.25, 0.8125, 0.3125, 0.875}, {0.3125, 0.8125, 0.375, 0.875}, {0.375, 0.8125, 0.4375, 0.875}, {0.4375, 0.8125, 0.5, 0.875}, {0.5, 0.8125, 0.5625, 0.875}, {0.5625, 0.8125, 0.625, 0.875}, {0.625, 0.8125, 0.6875, 0.875}, {0.6875, 0.8125, 0.75, 0.875}, {0.75, 0.8125, 0.8125, 0.875}, {0.8125, 0.8125, 0.875, 0.875}, {0.875, 0.8125, 0.9375, 0.875}, {0.9375, 0.8125, 1, 0.875},
	{0, 0.875, 0.0625, 0.9375}, {0.0625, 0.875, 0.125, 0.9375}, {0.125, 0.875, 0.1875, 0.9375}, {0.1875, 0.875, 0.25, 0.9375}, {0.25, 0.875, 0.3125, 0.9375}, {0.3125, 0.875, 0.375, 0.9375}, {0.375, 0.875, 0.4375, 0.9375}, {0.4375, 0.875, 0.5, 0.9375}, {0.5, 0.875, 0.5625, 0.9375}, {0.5625, 0.875, 0.625, 0.9375}, {0.625, 0.875, 0.6875, 0.9375}, {0.6875, 0.875, 0.75, 0.9375}, {0.75, 0.875, 0.8125, 0.9375}, {0.8125, 0.875, 0.875, 0.9375}, {0.875, 0.875, 0.9375, 0.9375}, {0.9375, 0.875, 1, 0.9375},
	{0, 0.9375, 0.0625, 1}, {0.0625, 0.9375, 0.125, 1}, {0.125, 0.9375, 0.1875, 1}, {0.1875, 0.9375, 0.25, 1}, {0.25, 0.9375, 0.3125, 1}, {0.3125, 0.9375, 0.375, 1}, {0.375, 0.9375, 0.4375, 1}, {0.4375, 0.9375, 0.5, 1}, {0.5, 0.9375, 0.5625, 1}, {0.5625, 0.9375, 0.625, 1}, {0.625, 0.9375, 0.6875, 1}, {0.6875, 0.9375, 0.75, 1}, {0.75, 0.9375, 0.8125, 1}, {0.8125, 0.9375, 0.875, 1}, {0.875, 0.9375, 0.9375, 1}, {0.9375, 0.9375, 1, 1},
};

static const int gfontres[] =
{
	640, 800, 1024, 1152, 1280, 1600, 1920
};

static ihandle_t font_alloc()
{
	int i;
	font_s* fnt;

	for (i = 0; i < MAX_FONTS; i++)
	{
		fnt = gfonts + i;
		if (!fnt->name[0])
			return i;
	}

	con_print(COLOR_RED, "MAX_FONTS");
	return BAD_HANDLE;
}

static void font_free(ihandle_t idx)
{
	font_s* fnt = gfonts + idx;
	if (!fnt->name[0])
		return;

	util_tex_free(fnt->texture);
	fnt->name[0] = '\0';
	fnt->texture = 0;
}

static ihandle_t font_find(const char* name)
{
	int i;
	font_s* fnt;

	for (i = 0; i < MAX_FONTS; i++)
	{
		fnt = gfonts + i;
		if (fnt->name[0] && strcmpi(fnt->name, name))
			return i;
	}

	return BAD_HANDLE;
}

int font_height(ihandle_t idx)
{
	if ((unsigned)idx >= MAX_FONTS)
		return 0;
	return gfonts[idx].height;
}

int font_len(ihandle_t idx, const char* text)
{
	font_s* f;
	int len, k, space;

	if ((unsigned)idx >= MAX_FONTS)
		return 0;

	f = gfonts + idx;
	if (!f || !f->name[0])
		return 0;

	len = 0;
	space = f->height >> 1;

	for (; *text; text++)
	{
		k = (byte)(*text);
		if (!f->widths[k])
			len += space;
		else
			len += f->widths[k];
	}

	return len;
}

int font_print(ihandle_t idx, const char* text, int x, int y, render_e render, byte r, byte g, byte b, byte a)
{
	font_s* f;
	int dh, numdraw, size, k, space;
	static vec2_t verts[FONT_VERTS];
	static vec2_t texcoords[FONT_VERTS];

	if ((unsigned)idx >= MAX_FONTS || strnull(text))
		return x;

	f = gfonts + idx;
	if (!f || !f->name[0])
		return x;

	space = f->height >> 1;
	size = f->height;
	dh = y + size;
	numdraw = 0;

	for (; *text; text++)
	{
		k = (byte)(*text);
		if (!f->widths[k])
		{
			x += space;
			continue;
		}

		x -= f->starts[k];
		vec2_set(texcoords[numdraw], gfontmap[k][0], gfontmap[k][1]);
		vec2_set(verts[numdraw], x, y);
		numdraw++;

		vec2_set(texcoords[numdraw], gfontmap[k][2], gfontmap[k][1]);
		vec2_set(verts[numdraw], x + size, y);
		numdraw++;

		vec2_set(texcoords[numdraw], gfontmap[k][2], gfontmap[k][3]);
		vec2_set(verts[numdraw], x + size, dh);
		numdraw++;

		vec2_set(texcoords[numdraw], gfontmap[k][0], gfontmap[k][3]);
		vec2_set(verts[numdraw], x, dh);
		numdraw++;

		x += f->starts[k] + f->widths[k];
		if (numdraw >= FONT_VERTS)
			break;
	}

	if (!numdraw)
		return x;

	vid_rendermode(render);
	img_bind(f->texture);
	glColor4ub(r, g, b, a);
	glVertexPointer(2, GL_FLOAT, 0, verts);
	glTexCoordPointer(2, GL_FLOAT, 0, texcoords);
	glDrawArrays(GL_QUADS, 0, numdraw);
	return x;
}

static char* font_adjust_res(const char* name)
{
	int num = ARRAYSIZE(gfontres) - 1;

	while (gfontres[num] > gvid.width)
	{
		num--;
		if (num < 0)
			return NULL;
	}

	while (TRUE)
	{
		sprintf(ghost.string, FONT_FOLDER"%i_%s.fnt", gfontres[num], name);
		if (util_exist(ghost.string))
			break;

		num--;
		if (num < 0)
			return NULL;
	}

	return ghost.string;
}

static void font_load(const char* name, font_s* out)
{
	byte table[3][4];
	const char* fullname;
	byte* file, * src, * data;
	int len, color, count, sz, val, * p, add, i, j;

	fullname = font_adjust_res(name);
	if (!fullname)
	{
		con_printf(COLOR_RED, "%s - font not found", name);
		return;
	}

	file = src = util_full(fullname, &len);
	if (!file)
	{
		con_printf(COLOR_RED, "%s - unknown error", fullname);
		return;
	}

	if (*(int*)file != FONT_MAGIC || len < 64)
	{
		util_free(src);
		con_printf(COLOR_RED, "%s - bad header", fullname);
		return;
	}

	sz = *(word*)(file + 4);
	if (sz != ((sz >> 2) << 2) || sz * sz > IMG_MAX_SIZE)
	{
		util_free(src);
		con_printf(COLOR_RED, "%s - bad size %i x %i", fullname, sz, sz);
		return;
	}

	file += 6;
	out->height = sz / FONT_DIMENSION;
	add = (int)(0.5f + 0.1f * out->height);
	for (i = 0, j = 0; i < (FONT_LETTERS << 1); i += 2, j++)
	{
		if (!file[i + 1])
		{
			out->starts[j] = out->widths[j] = 0;
			continue;
		}

		out->starts[j] = file[i + 0];
		out->widths[j] = file[i + 1] + add;
	}

	len = sz * sz;
	data = util_malloc(len << 2);
	file += FONT_LETTERS << 1;
	p = (int*)data;

	vec4_set(table[0], 0, 0, 0, 0);
	vec4_set(table[1], 255, 255, 255, 255);
	vec4_set(table[2], 0, 0, 0, 255);

	while (len > 0)
	{
		count = file[0];
		color = file[1];

		file += 2;
		len -= count;

		val = *(int*)table[color];
		while (count-- > 0)
			*p++ = val;
	}

	gimg.clamp = TRUE;
	gimg.nearest = TRUE;
	gimg.mipmap = FALSE;
	out->texture = img_upload(data, sz, sz, GL_RGBA);
	util_free(src);
}

ihandle_t font_precache(const char* fontname)
{
	font_s* fnt;
	ihandle_t idx;

	if (!ghost.load_is_allow)
	{
		con_printf(COLOR_RED, "%s - precache is not allowed");
		return BAD_HANDLE;
	}

	if (strnull(fontname))
		return BAD_HANDLE;

	idx = font_find(fontname);
	if (idx != BAD_HANDLE)
		return idx;

	idx = font_alloc();
	if (idx == BAD_HANDLE)
		return BAD_HANDLE;

	fnt = gfonts + idx;
	font_load(fontname, fnt);
	if (!fnt->texture)
		return BAD_HANDLE;

	strcpyn(fnt->name, fontname);
	fnt->is_temp = ghost.load_as_temp;
	return idx;
}

void font_init()
{
	ghost.load_as_temp = FALSE;
	ghost.load_is_allow = TRUE;

	gconfont = font_precache("console");
	ggame.font_init();

	ghost.load_is_allow = FALSE;
}

void font_free_all()
{
	int i;

	for (i = 0; i < MAX_FONTS; i++)
		font_free(i);
}

void font_free_temp()
{
	int i;

	for (i = 0; i < MAX_FONTS; i++)
	{
		if (gfonts[i].is_temp)
			font_free(i);
	}
}